<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Finalizar Pedido - Lanchonete</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">üçî Lanchonete</a>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        
        <!-- Progress Steps -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div class="text-center flex-fill" id="step-1">
                <div class="step-circle active">1</div>
                <small>Contato</small>
              </div>
              <div class="text-center flex-fill" id="step-2">
                <div class="step-circle">2</div>
                <small>Endere√ßo</small>
              </div>
              <div class="text-center flex-fill" id="step-3">
                <div class="step-circle">3</div>
                <small>Confirma√ß√£o</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Formul√°rio -->
        <div class="card shadow">
          <div class="card-body p-4" id="checkout-content"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { criarPedido } from './js/api.js';

    let etapaAtual = 1;
    let dadosCheckout = {
      telefone: '',
      endereco: ''
    };

    const content = document.getElementById('checkout-content');

    function atualizarSteps() {
      for (let i = 1; i <= 3; i++) {
        const step = document.getElementById(`step-${i}`);
        const circle = step.querySelector('.step-circle');
        if (i < etapaAtual) {
          circle.classList.add('completed');
          circle.classList.remove('active');
        } else if (i === etapaAtual) {
          circle.classList.add('active');
          circle.classList.remove('completed');
        } else {
          circle.classList.remove('active', 'completed');
        }
      }
    }

    function renderEtapa1() {
      content.innerHTML = `
        <h4 class="mb-4">üìû Contato para Entrega</h4>
        <div class="mb-3">
          <label for="telefone" class="form-label">Telefone (com DDD):</label>
          <input type="tel" id="telefone" class="form-control form-control-lg" 
                 placeholder="(32) 98877-6655" value="${dadosCheckout.telefone}">
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary btn-lg" id="btn-proximo">
            Pr√≥ximo ‚Üí
          </button>
          <a href="carrinho.html" class="btn btn-outline-secondary">
            ‚Üê Voltar ao Carrinho
          </a>
        </div>
      `;

      document.getElementById('btn-proximo').addEventListener('click', () => {
        const tel = document.getElementById('telefone').value.trim();
        if (tel.length < 10) {
          alert('Por favor, digite um telefone v√°lido!');
          return;
        }
        dadosCheckout.telefone = tel;
        etapaAtual = 2;
        atualizarSteps();
        renderEtapa2();
      });
    }

    function renderEtapa2() {
      content.innerHTML = `
        <h4 class="mb-4">üìç Endere√ßo de Entrega</h4>
        <div class="mb-3">
          <label for="endereco" class="form-label">Endere√ßo Completo:</label>
          <textarea id="endereco" class="form-control" rows="3" 
                    placeholder="Rua, n√∫mero, bairro, complemento">${dadosCheckout.endereco}</textarea>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary btn-lg" id="btn-proximo">
            Pr√≥ximo ‚Üí
          </button>
          <button class="btn btn-outline-secondary" id="btn-voltar">
            ‚Üê Voltar
          </button>
        </div>
      `;

      document.getElementById('btn-proximo').addEventListener('click', () => {
        const end = document.getElementById('endereco').value.trim();
        if (end.length < 10) {
          alert('Por favor, digite um endere√ßo v√°lido!');
          return;
        }
        dadosCheckout.endereco = end;
        etapaAtual = 3;
        atualizarSteps();
        renderEtapa3();
      });

      document.getElementById('btn-voltar').addEventListener('click', () => {
        etapaAtual = 1;
        atualizarSteps();
        renderEtapa1();
      });
    }

    function renderEtapa3() {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const total = cart.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);

      content.innerHTML = `
        <h4 class="mb-4">‚úÖ Confirmar Pedido</h4>
        
        <div class="alert alert-info">
          <strong>Telefone:</strong> ${dadosCheckout.telefone}<br>
          <strong>Endere√ßo:</strong> ${dadosCheckout.endereco}
        </div>

        <h6 class="mb-3">Itens do Pedido:</h6>
        <div class="mb-3">
          ${cart.map(item => `
            <div class="d-flex justify-content-between mb-2">
              <span>${item.quantidade}x ${item.nome} ${item.tamanho ? `(${item.tamanho})` : ''}</span>
              <strong>R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</strong>
            </div>
          `).join('')}
        </div>

        <hr>
        <div class="d-flex justify-content-between mb-4">
          <h5>Total:</h5>
          <h5 class="text-success">R$ ${total.toFixed(2).replace('.', ',')}</h5>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-success btn-lg" id="btn-confirmar">
            üéâ Confirmar Pedido
          </button>
          <button class="btn btn-outline-secondary" id="btn-voltar">
            ‚Üê Voltar
          </button>
        </div>
      `;

      document.getElementById('btn-confirmar').addEventListener('click', finalizarPedido);
      document.getElementById('btn-voltar').addEventListener('click', () => {
        etapaAtual = 2;
        atualizarSteps();
        renderEtapa2();
      });
    }

    async function finalizarPedido() {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      
      const pedido = {
        cliente: {
          telefone: dadosCheckout.telefone,
          endereco: {
            rua: dadosCheckout.endereco.split(',')[0] || dadosCheckout.endereco,
            numero: '0',
            bairro: 'N/A',
            cidade: 'N/A',
            complemento: dadosCheckout.endereco
          }
        },
        itens: cart.map(item => ({
          produto: { id: item.produtoId },
          quantidade: item.quantidade,
          precoUnitario: item.preco
        }))
      };

      try {
        content.innerHTML = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p>Enviando pedido...</p>
          </div>
        `;

        const resultado = await criarPedido(pedido);
        
        localStorage.setItem('pedidoConfirmado', JSON.stringify(resultado));
        localStorage.removeItem('cart');
        window.location.href = 'pedido-confirmado.html';

      } catch (error) {
        alert('Erro ao criar pedido: ' + error.message);
        etapaAtual = 1;
        atualizarSteps();
        renderEtapa1();
      }
    }

    // Inicializa√ß√£o
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) {
      window.location.href = 'carrinho.html';
    }

    atualizarSteps();
    renderEtapa1();
  </script>

  <style>
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .step-circle.active {
      background: #0d6efd;
      color: white;
    }
    .step-circle.completed {
      background: #198754;
      color: white;
    }
  </style>
</body>
</html>