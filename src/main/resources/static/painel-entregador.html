<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Entregador - Lanchonete</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-success">
    <div class="container-fluid">
      <span class="navbar-brand">üöó Painel do Entregador</span>
      <div>
        <span class="text-white me-3 fw-bold" id="user-name"></span>
        <button class="btn btn-light btn-sm" id="btn-logout">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row mb-4">
      <div class="col">
        <h3>Pedidos para Entrega</h3>
        <p class="text-muted">Pedidos conclu√≠dos aguardando entrega</p>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" onclick="atualizarPedidos()">
          üîÑ Atualizar
        </button>
      </div>
    </div>

    <!-- Lista de Pedidos -->
    <div id="lista-pedidos" class="row g-3"></div>
  </div>

  <!-- Modal para c√≥digo de entrega -->
  <div class="modal fade" id="modalCodigo" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Finalizar Entrega</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Digite o c√≥digo de entrega fornecido pelo cliente:</p>
          <input type="text" class="form-control form-control-lg text-center" 
                 id="input-codigo" placeholder="000000" maxlength="6">
          <div id="erro-codigo" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="validarCodigo()">Confirmar Entrega</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { listarPedidos, atualizarStatusPedido } from './js/api.js';

    // Verificar autentica√ß√£o
    const usuario = JSON.parse(sessionStorage.getItem('usuario'));
    if (!usuario || usuario.cargo !== 'ENTREGADOR') {
      window.location.href = 'login-admin.html';
    }
    document.getElementById('user-name').textContent = usuario.nome;

    // Logout
    document.getElementById('btn-logout').addEventListener('click', () => {
      sessionStorage.removeItem('usuario');
      window.location.href = 'index.html';
    });

    let pedidoSelecionado = null;

    async function carregarPedidos() {
      const container = document.getElementById('lista-pedidos');
      
      try {
        const pedidos = await listarPedidos();
        const pedidosConcluidos = pedidos.filter(p => p.status === 'CONCLUIDO');

        if (pedidosConcluidos.length === 0) {
          container.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info text-center">
                <h5>‚úÖ Nenhum pedido para entregar no momento</h5>
                <p class="mb-0">Todos os pedidos foram entregues!</p>
              </div>
            </div>
          `;
          return;
        }

        container.innerHTML = pedidosConcluidos.map(pedido => {
          // Formatar endere√ßo completo
          const endereco = pedido.cliente?.endereco;
          let enderecoCompleto = 'Endere√ßo n√£o informado';
          
          if (endereco) {
            const partes = [];
            if (endereco.rua) partes.push(endereco.rua);
            if (endereco.numero) partes.push(endereco.numero);
            if (endereco.complemento) partes.push(endereco.complemento);
            if (endereco.bairro) partes.push(endereco.bairro);
            if (endereco.cidade) partes.push(endereco.cidade);
            
            enderecoCompleto = partes.join(', ');
          }

          return `
          <div class="col-md-6 col-lg-4">
            <div class="card shadow h-100">
              <div class="card-header bg-success text-white">
                <strong>Pedido #${pedido.id}</strong>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <strong>üïê Hor√°rio:</strong><br>
                  <small>${new Date(pedido.dataHora).toLocaleString('pt-BR')}</small>
                </div>

                <div class="mb-3">
                  <strong>üìû Cliente:</strong><br>
                  <div class="mt-1">
                    <strong>${pedido.cliente?.nome || 'Cliente'}</strong><br>
                    <a href="tel:${pedido.cliente?.telefone || ''}" class="btn btn-sm btn-outline-primary mt-1">
                      ${pedido.cliente?.telefone || 'Telefone n√£o informado'}
                    </a>
                  </div>
                </div>

                <div class="mb-3">
                  <strong>üìç Endere√ßo:</strong><br>
                  <small class="text-muted">
                    ${enderecoCompleto}
                  </small>
                </div>

                <div class="mb-3">
                  <strong>üí∞ Total:</strong> 
                  <span class="text-success fw-bold">R$ ${pedido.total?.toFixed(2) || '0.00'}</span>
                </div>

                <div class="d-grid">
                  <button class="btn btn-success" onclick="iniciarFinalizacao(${pedido.id}, '${pedido.codigoEntrega}')">
                    ‚úÖ Finalizar Entrega
                  </button>
                </div>
              </div>
            </div>
          </div>
        `}).join('');

      } catch (error) {
        container.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">Erro ao carregar pedidos: ${error.message}</div>
          </div>
        `;
      }
    }

    window.iniciarFinalizacao = (idPedido, codigoCorreto) => {
      pedidoSelecionado = { id: idPedido, codigo: codigoCorreto };
      document.getElementById('input-codigo').value = '';
      document.getElementById('erro-codigo').style.display = 'none';
      new bootstrap.Modal(document.getElementById('modalCodigo')).show();
    };

    window.validarCodigo = async () => {
      const codigoDigitado = document.getElementById('input-codigo').value.trim();
      const erroDiv = document.getElementById('erro-codigo');

      if (!codigoDigitado) {
        erroDiv.textContent = 'Por favor, digite o c√≥digo!';
        erroDiv.style.display = 'block';
        return;
      }

      if (codigoDigitado !== pedidoSelecionado.codigo) {
        erroDiv.textContent = 'C√≥digo inv√°lido! Verifique e tente novamente.';
        erroDiv.style.display = 'block';
        return;
      }

      try {
        await atualizarStatusPedido(pedidoSelecionado.id, 'ENTREGUE');
        bootstrap.Modal.getInstance(document.getElementById('modalCodigo')).hide();
        alert('‚úÖ Entrega finalizada com sucesso!');
        await carregarPedidos();
      } catch (error) {
        erroDiv.textContent = 'Erro ao finalizar entrega: ' + error.message;
        erroDiv.style.display = 'block';
      }
    };

    window.atualizarPedidos = carregarPedidos;

    // Auto-atualizar a cada 30 segundos
    setInterval(carregarPedidos, 30000);

    // Carregar dados iniciais
    carregarPedidos();
  </script>
</body>
</html>